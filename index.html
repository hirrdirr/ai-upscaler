<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>AI Upscaler – Client-side</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .card {
      max-width: 900px;
      margin: 0 auto;
      background: #181818;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      border: 1px solid #333;
    }
    h1 {
      margin-top: 0;
      font-size: 1.7rem;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #bbb;
      margin-bottom: 16px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }
    label {
      font-size: 0.9rem;
      color: #ccc;
    }
    select {
      background: #101010;
      color: #eee;
      border-radius: 6px;
      border: 1px solid #333;
      padding: 6px 8px;
    }
    input[type="file"] {
      color: #ddd;
      max-width: 260px;
    }
    button {
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #status {
      font-size: 0.9rem;
      margin: 8px 0 8px 0;
      color: #aaa;
    }

    /* Progressbar */
    #progressContainer {
      width: 100%;
      background: #222;
      border-radius: 6px;
      overflow: hidden;
      height: 12px;
      display: none;
      margin-bottom: 12px;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      transition: width 0.25s ease-out;
    }

    .preview-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 10px;
    }
    .preview {
      background: #101010;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #222;
    }
    .preview h2 {
      margin: 0 0 8px 0;
      font-size: 1rem;
    }
    .preview img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      background: black;
    }
    .dims {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #999;
      font-family: "JetBrains Mono", "Fira Code", monospace;
    }
    #downloadLink {
      display: inline-block;
      margin-top: 8px;
      color: #4ade80;
      font-size: 0.9rem;
      text-decoration: none;
    }
    .hint {
      font-size: 0.8rem;
      color: #888;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>AI Upscaler</h1>
    <p class="subtitle">
      Allt körs direkt i din webbläsare. Inga bilder laddas upp till någon server.
    </p>

    <div class="controls">
      <input type="file" id="fileInput" accept="image/*" />

      <label for="scaleSelect">Skala:</label>
      <select id="scaleSelect">
        <option value="2">2x (rekommenderad)</option>
        <option value="4">4x (tung)</option>
        <option value="6">6x (experimentell)</option>
        <option value="8">8x (endast små bilder)</option>
      </select>

      <label for="modelSelect">Modell:</label>
      <select id="modelSelect">
        <option value="thick">Thick – max skärpa</option>
        <option value="medium">Medium – balans</option>
        <option value="default">Default – snabbast</option>
      </select>

      <button id="upscaleBtn" disabled>Upscale</button>
    </div>

    <div class="hint">
      Modell: <b>Thick</b> ger bäst detalj (liknar UltraSharp-stil) men är tyngst.
      Medium är kompromiss. Default är snabbast. 6x/8x kräver liten bild och hyfsad dator.
    </div>

    <div id="status">Ladda upp en bild för att börja.</div>

    <!-- Progress bar -->
    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>

    <div class="preview-wrapper">
      <div class="preview">
        <h2>Original</h2>
        <img id="originalImg" />
        <p class="dims" id="originalDims">–</p>
      </div>
      <div class="preview">
        <h2>Upscalad</h2>
        <img id="upscaledImg" />
        <p class="dims" id="upscaledDims">–</p>
        <a id="downloadLink" href="#" download="upscaled.png" style="display:none;">Ladda ner bild</a>
      </div>
    </div>
  </div>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <!-- Default-model (snabb) -->
  <script src="https://cdn.jsdelivr.net/npm/@upscalerjs/default-model@latest/dist/umd/index.min.js"></script>
  <!-- ESRGAN Medium 2x (balans) -->
  <script src="https://cdn.jsdelivr.net/npm/@upscalerjs/esrgan-medium@latest/dist/umd/2x.min.js"></script>
  <!-- ESRGAN Thick 2x (max kvalitet) -->
  <script src="https://cdn.jsdelivr.net/npm/@upscalerjs/esrgan-thick@latest/dist/umd/2x.min.js"></script>
  <!-- UpscalerJS -->
  <script src="https://cdn.jsdelivr.net/npm/upscaler@latest/dist/browser/umd/upscaler.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const upscaleBtn = document.getElementById('upscaleBtn');
    const originalImg = document.getElementById('originalImg');
    const upscaledImg = document.getElementById('upscaledImg');
    const downloadLink = document.getElementById('downloadLink');
    const statusEl = document.getElementById('status');
    const scaleSelect = document.getElementById('scaleSelect');
    const modelSelect = document.getElementById('modelSelect');

    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');

    const originalDims = document.getElementById('originalDims');
    const upscaledDims = document.getElementById('upscaledDims');

    // Max output-storlek för 8x (skydd mot browser-död)
    const MAX_OUTPUT_SIZE_PX = 8000; // längsta sida

    function formatDims(w, h) {
      if (!w || !h) return '–';
      return `${w} × ${h} px`;
    }

    function waitForImageLoad(img) {
      return new Promise((resolve, reject) => {
        if (img.complete && img.naturalWidth > 0) return resolve();
        img.onload = () => resolve();
        img.onerror = err => reject(err);
      });
    }

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = ev => {
        originalImg.src = ev.target.result;
        upscaledImg.src = '';
        downloadLink.style.display = 'none';
        upscaledDims.textContent = '–';

        upscaleBtn.disabled = false;
        statusEl.textContent = 'Bild laddad. Välj skala och modell, sedan kör.';

        waitForImageLoad(originalImg).then(() => {
          originalDims.textContent = formatDims(
            originalImg.naturalWidth,
            originalImg.naturalHeight
          );
        });
      };
      reader.readAsDataURL(file);
    });

    // Steg-baserad progress: stepIndex börjar på 1
    function setStepProgress(stepIndex, totalSteps) {
      progressContainer.style.display = 'block';
      const fraction = stepIndex / totalSteps;
      const percent = Math.round(fraction * 90); // max 90 %, sista 10 % vid klar
      progressBar.style.width = percent + '%';
    }

    function finishProgress() {
      progressBar.style.width = '100%';
      setTimeout(() => {
        progressContainer.style.display = 'none';
        progressBar.style.width = '0%';
      }, 600);
    }

    function isScaleSafe(scale) {
      const w = originalImg.naturalWidth || 0;
      const h = originalImg.naturalHeight || 0;
      if (!w || !h) return true;

      const targetW = w * scale;
      const targetH = h * scale;

      if (targetW > MAX_OUTPUT_SIZE_PX || targetH > MAX_OUTPUT_SIZE_PX) {
        alert(
          `Bilden är för stor för ${scale}x i webbläsaren.\n\n` +
          `Original: ${w}×${h}px\n` +
          `Skulle bli: ${Math.round(targetW)}×${Math.round(targetH)}px\n\n` +
          `Testa 2x eller 4x istället, eller använd en mindre bild.`
        );
        return false;
      }
      return true;
    }

    // Canvas-scaling för 6x (2x AI + 3x vanlig scaling)
    function scaleWithCanvas(src, factor) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(img.width * factor);
          canvas.height = Math.round(img.height * factor);
          const ctx = canvas.getContext('2d');
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = reject;
        img.src = src;
      });
    }

    // Plocka rätt modell baserat på dropdown
    function getSelectedModel() {
      const key = modelSelect.value;
      if (key === 'default') {
        // global från default-model UMD
        return DefaultUpscalerJSModel;
      }
      if (key === 'medium') {
        // global från esrgan-medium/2x UMD
        return ESRGANMedium2x;
      }
      // thick som default om något knasar
      return ESRGANThick2x;
    }

    upscaleBtn.addEventListener('click', async () => {
      if (!originalImg.src) return;

      const scale = parseInt(scaleSelect.value, 10);
      if (!isScaleSafe(scale)) {
        return;
      }

      const model = getSelectedModel();
      let modelLabel = modelSelect.options[modelSelect.selectedIndex].text;
      statusEl.textContent = `Upscalear (${scale}x) med modell: ${modelLabel}...`;

      // skapar en ny Upscaler-instans per körning, baserat på vald modell
      const upscaler = new Upscaler({ model });

      upscaleBtn.disabled = true;
      fileInput.disabled = true;

      // visa progress direkt på ~5 %
      progressContainer.style.display = 'block';
      progressBar.style.width = '5%';

      try {
        const opts = { patchSize: 64, padding: 8 };
        let finalSrc = null;

        if (scale === 2) {
          // 1 steg
          setStepProgress(1, 1);
          finalSrc = await upscaler.upscale(originalImg, opts);
        } else if (scale === 4) {
          // 2 steg: 2x + 4x
          statusEl.textContent = `Steg 1/2 (2x) – ${modelLabel}...`;
          setStepProgress(1, 2);
          const first = await upscaler.upscale(originalImg, opts);

          const tempImg = new Image();
          tempImg.src = first;
          await waitForImageLoad(tempImg);

          statusEl.textContent = `Steg 2/2 (4x) – ${modelLabel}...`;
          setStepProgress(2, 2);
          finalSrc = await upscaler.upscale(tempImg, opts);
        } else if (scale === 6) {
          // 2 steg: 2x AI + 3x canvas
          statusEl.textContent = `Steg 1/2 (2x AI) – ${modelLabel}...`;
          setStepProgress(1, 2);
          const first = await upscaler.upscale(originalImg, opts);

          statusEl.textContent = 'Steg 2/2 (3x skalning)...';
          setStepProgress(2, 2);
          finalSrc = await scaleWithCanvas(first, 3);
        } else if (scale === 8) {
          // 3 steg: 2x, 4x, 8x
          statusEl.textContent = `Steg 1/3 (2x) – ${modelLabel}...`;
          setStepProgress(1, 3);
          const first = await upscaler.upscale(originalImg, opts);

          const temp1 = new Image();
          temp1.src = first;
          await waitForImageLoad(temp1);

          statusEl.textContent = `Steg 2/3 (4x) – ${modelLabel}...`;
          setStepProgress(2, 3);
          const second = await upscaler.upscale(temp1, opts);

          const temp2 = new Image();
          temp2.src = second;
          await waitForImageLoad(temp2);

          statusEl.textContent = `Steg 3/3 (8x) – ${modelLabel}...`;
          setStepProgress(3, 3);
          finalSrc = await upscaler.upscale(temp2, opts);
        } else {
          // fallback
          setStepProgress(1, 1);
          finalSrc = await upscaler.upscale(originalImg, opts);
        }

        upscaledImg.src = finalSrc;
        await waitForImageLoad(upscaledImg);
        upscaledDims.textContent = formatDims(
          upscaledImg.naturalWidth,
          upscaledImg.naturalHeight
        );

        downloadLink.href = finalSrc;
        downloadLink.style.display = 'inline-block';
        statusEl.textContent = `Klar! Upscalad till ${scale}x med modell: ${modelLabel}.`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Ett fel inträffade. Öppna konsolen (F12) för detaljer.';
      }

      finishProgress();
      upscaleBtn.disabled = false;
      fileInput.disabled = false;
    });
  </script>
</body>
</html>
